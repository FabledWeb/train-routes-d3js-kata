<!DOCTYPE html>
<html>
  <head> 
    <meta charset="utf-8">
    <style>
    .node {
      stroke: #fff;
      stroke-width: 1.5px;
    }

    .link {
      stroke-opacity: .6;
      stroke-width: 5;
      /*
      stroke: #999;
      marker-start: url(#triangle);
      */
    }
    #canvas {
      height: 100%;
      width: 100%;
      top: 0;
      left: 0;
      position: absolute;
    }
    </style>
  </head> 
  <body>
    <svg id="canvas"></svg>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.min.js"></script>
    <script>
      var locations = {};
      var data = d3.csv.parse(
        "source,destination,distance\n"+
        "Frolia,Hailea,9\n"+
        "Hailea,Hanalei,5\n"+
        "Hanalei,Maeulia,6\n"+
        "Hauauai,Lainea,8\n"+
        "Kaleola,Maeulia,7\n"+
        "Lainea,Hailea,5\n"+
        "Lakua,Hauauai,3\n"+
        "Maeulia,Hailea,12\n"+
        "Paukaa,Hauauai,6\n"+
        "Poipu,Paukaa,9\n"+
        "Hailea,Waimea,4\n"+
        "Waimea,Lakua,9\n"+
        "Lakua,Poipu,7\n"+
        "Waimea,Kaleola,4\n"+
        "Maeulia,Paukaa,14\n"+
        "Hailea,Lainea,8",
        function(d) {
          //convert distance from a string to a number
          d.distance = +d.distance;
          locations[d.source] = locations[d.source] || {destinations:{}};
          locations[d.source].destinations[d.destination] = d.distance;
          locations[d.destination] = locations[d.destination] || {destinations:{}};
          return d;
        }
      );
      var nodes = _.map(Object.keys(locations), function(source,index) {
        locations[source].index = index;
        return {
          index: index,
          name: source,
          destinations: locations[source].destinations
        };
      });
      console.log('locations',locations);
      var edges = [];
      _.forEach(nodes, function(source,index) {
          console.log('source',source);
        _.forIn(source.destinations, function(distance,destName) {
          console.log('destName',destName);
          console.log('dest info',locations[destName]);
          edges.push({
            source: source.index,
            target: locations[destName].index
          });
        });
      });
      
      console.log('data',data);
      console.log('nodes',nodes);
      console.log('edges',edges);

      var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

      var routeScale = Math.min(width,height)/20;

      var color = d3.scale.category20();

      var force = d3.layout.force()
          .charge(-2000)
          .linkDistance(function(d) {
            return d.source.destinations[d.target.name]*routeScale;
          })
          .size([width, height]);

      var svg = d3.select("#canvas");
      
      //arrow head marker (used to show direction of route)
      force
        .nodes(nodes)
        .links(edges)
        .start();

      var addArrows = function(x,label) {
        svg.selectAll('marker_'+label)
          .data(edges)
          .enter().append('marker')
            .attr('id', function(d,i){ return 'marker_'+label + i})
            .attr('markerHeight', 3)
            .attr('markerWidth', 4)
            .attr('markerUnits', 'strokeWidth')
            .attr('orient', 'auto')
            .attr('refX', x)
            .attr('refY', 5)
            .attr('viewBox', '0 0 10 10')
            .append('path')
              .attr('fill-opacity', 0.6)
              .attr('d', "M 0 0 L 10 5 L 0 10 z")
              .attr('fill', function(d,i) { return color(i); });
      };

      addArrows(-30,'start');
      addArrows(30,'end');

      var link = svg.selectAll(".link")
        .data(edges)
        .enter().append("line")
        .attr("class", "link")
        .attr('marker-start', function(d,i) { return 'url(#marker_start' + i + ')' })
        .attr('marker-end', function(d,i) { return 'url(#marker_end' + i + ')' })
        .attr("stroke", function(d,i) { return color(i); });

      var node = svg.selectAll(".node")
        .data(nodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", 10);
        //.call(force.drag);

      var text = svg.selectAll(".text")
        .data(nodes)
        .enter().append("text")
        .attr('x',function(d) { return d.x; })
        .attr('y',function(d) { return d.y; })
        .attr('class', 'text')
        .text(function(d) { return d.name; });

      node.append("title")
        .text(function(d) { return d.name; });

      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; })

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });

        text.attr("x", function(d) { return d.x - 30; })
            .attr("y", function(d) { return d.y - 20; });
      });

    </script>
  </body>
</html>
